<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
  <meta name="description" content="" />
  <meta name="author" content="" />
  <link rel="icon" href="/public/img/asset-favicon.ico" />
  <title>社交-登录注册</title>
  <!-- 页面 css js -->
  <!-- <script type="text/javascript" src="../../plugins/sui/sui.min.js" charset="UTF-8"></script> -->
  <link rel="stylesheet" type="text/css" href="/public/plugins/normalize-css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="/public/plugins/yui/cssgrids-min.css" />
  <link rel="stylesheet" type="text/css" href="/public/plugins/sui/sui.min.css" />
  <link rel="stylesheet" type="text/css" href="/public/plugins/sui/sui-append.min.css" />
  <link rel="stylesheet" type="text/css" href="/public/plugins/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" type="text/css" href="/public/css/widget-base.css" />
  <link rel="stylesheet" type="text/css" href="/public/css/widget-head-foot.css" />
  <link rel="stylesheet" type="text/css" href="/public/css/page-sj-person-loginsign.css" />
  <style>
    .error {
      display: block;
      color: #e93323;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <!--头部导航-->
  <header class="head-login">
    <div class="wrapper">
      <div class="sui-navbar">
        <div class="navbar-inner">
          <a href="./index.html" class="sui-brand"> <img src="/public/img/asset-logo-black.png" alt="社交" /> </a>
          <span class="login-text">| 登录注册</span>
        </div>
      </div>
    </div>
  </header>
  <div class="wrapper loginsign">
    <div class="item signup">
      <div class="form">
        <h3 class="loginsign-title">注册新账号</h3>
        <form class="sui-form" id="register_form">
          <div class="control-group">
            <label for="username" class="control-label">用户名</label>
            <div class="controls">
              <input type="text" name="username" id="username" placeholder="真实姓名或常用昵称" class="input-xlarge" />
            </div>
          </div>
          <div class="control-group">
            <label for="password" class="control-label">密码</label>
            <div class="controls">
              <input type="text" id="password" name="password" placeholder="请输入4-16位密码" class="input-xlarge" />
            </div>
          </div>
          <div class="different">
            <div class="radio-content">
              <div id="a1" class="phone">
                <div class="control-group">
                  <label for="nickname" class="control-label">昵称</label>
                  <div class="controls">
                    <input type="text" id="nickname" name="nickname" placeholder="请输入昵称" class="input-xlarge" />
                  </div>
                </div>
                <div class="control-group code">
                  <label for="captcha" class="control-label">验证码</label>
                  <div class="input-append">
                    <input id="captcha" type="text" placeholder="短信验证" class="span2 input-large msg-input"
                      name="captcha" />
                    <!-- <button type="button" class="sui-btn msg-btn">获取验证码</button> -->
                    <img src="/captcha" alt="" id="svg-captcha">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="control-group btn-signup">
            <label class="control-label"></label>
            <div class="controls">
              <label>
                <input type="checkbox" name="isAgree" /><span class="type-text"
                  style="font-size:12px;">同意协议并接受《服务条款》</span>
              </label>
              <button type="submit" class="sui-btn btn-danger btn-yes">注 册</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="item">
      <div class="form">
        <h3 class="loginsign-title">用户登录</h3>
        <p class="error" id="login_error" style="display: none"></p>
        <form class="sui-form" id="login_form">
          <div class="control-group">
            <label for="username" class="control-label">用户名</label>
            <div class="controls">
              <input type="text" id="username" name="username" placeholder="11位手机号" class="input-xlarge"
                data-rules="required" />
            </div>
          </div>
          <div class="control-group">
            <label for="password" class="control-label">密码</label>
            <div class="controls">
              <input type="text" id="password" name="password" placeholder="输入登录密码" class="input-xlarge" />
            </div>
          </div>
          <div class="controls">
            <label>
              <input type="checkbox" name="remember" /><span class="type-text" style="font-size:12px;">记住登录状态</span>
            </label>
            <button type="submit" class="sui-btn btn-danger btn-yes">登 录</button>
          </div>
          <div class="other-methods">
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="wrapper">
      <div class="footer-bottom">
        <div class="link">
          <dl>
            <dt>
              网站相关
            </dt>
            <dd>
              关于我们
            </dd>
            <dd>
              服务条款
            </dd>
            <dd>
              帮助中心
            </dd>
            <dd>
              编辑器语法
            </dd>
          </dl>
          <dl>
            <dt>
              常用链接
            </dt>
            <dd>
              传智播客
            </dd>
            <dd>
              传智论坛
            </dd>
          </dl>
          <dl>
            <dt>
              联系我们
            </dt>
            <dd>
              联系我们
            </dd>
            <dd>
              加入我们
            </dd>
            <dd>
              建议反馈
            </dd>
          </dl>
          <dl>
            <dt>
              关注我们
            </dt>
            <dd>
              微博
            </dd>
            <dd>
              twitter
            </dd>
          </dl>
          <div class="xuke">
            <h3>内容许可</h3>
            <p>除特别说明外，用户内容均采用知识共享署名-非商业性使用-禁止演绎4.0 国际许可协议 (CC BY-NC-ND 4.0) 进行许可</p>
            <p>本站由 传智研究院 提供更新服务</p>
          </div>
        </div>
        <p class="Copyright">Copyright &copy; 2017 传智问答社区 当前版本 0.0.1</p>
      </div>
    </div>
  </div>
</body>

<script src="/node_modules/jquery/dist/jquery.js"></script>
<script src="/node_modules/jquery-validation/dist/jquery.validate.js"></script>
<script>
  $(function () {

    const $registerForm = $('#register_form')

    const $loginForm = $('#login_form')

    // 注册验证
    $registerForm.validate({
      rules: {
        username: {
          required: true,
          minlength: 4,
          remote: '/user/check' // user/check?username=xxx
        },
        password: {
          required: true,
          minlength: 4
        },
        nickname: {
          required: true,
          remote: '/user/check' // user/check?nickname=xxx
        },
        captcha: {
          required: true,
          remote: '/captcha/check'
        },
        isAgree: {
          required: true
        }
      },
      messages: {
        username: {
          required: '用户名不能为空！',
          minlength: '用户名不能小于4位！',
          remote: '用户名已被占用'
        },
        password: {
          required: '密码不能为空！',
          minlength: '密码不能小于4位！',
        },
        nickname: {
          required: '昵称不能为空！',
          remote: '昵称已被占用'
        },
        captcha: {
          required: '验证码不能为空！',
          remote: '验证码不正确或者已过期，请点击刷新'
        },
        isAgree: {
          required: '必须同意协议！'
        }
      },
      submitHandler: function (form) {
        registerSub(form)
      }
      // debug: true
    })

    // 发送注册请求方法
    function registerSub(form) {
      $.ajax({
        url: '/register',
        method: 'POST',
        data: $registerForm.serialize(),
        success(res) {
          // console.log(res)
          if (res.code === 0) {
            alert(`注册成功, 用户名为${res.newUser.username}`)
          }
          // 重置表单
          form.reset()
        }
      })
      return false
    }

    // 登录验证
    $loginForm.validate({
      rules: {
        username: {
          required: true
        },
        password: {
          required: true
        }
      },
      messages: {
        username: {
          required: '用户名不能为空'
        },
        password: {
          required: '密码不能为空'
        }
      },
      submitHandler: function (form) {
        loginSub()
      }
    })

    // 登录请求方法
    function loginSub() {
      $.ajax({
        url: '/login',
        method: 'POST',
        data: $loginForm.serialize(),
        success(res) {
          // console.log(res)
          let {
            code,
            msg
          } = res
          if (code === 1) {
            $('#login_error').text(msg).show()
          } else if (code === 2) {
            $('#login_error').text(msg).show()
          } else if (code === 0) {
            $('#login_error').hide()
            alert(`登录成功！欢迎${res.user.username}`)
            // 存用户信息到localStronge
            window.localStorage.setItem('userInfo', JSON.stringify(res.user))
            // 跳转到首页
            window.location.href = '/'
          }
        }
      })
      return false
    }

    // 点击刷新验证码
    $('#svg-captcha').on('click', function () {
      // console.log('需要刷新验证码了！')
      $(this).attr('src', '/captcha?' + Math.random())
    })

  })
</script>

</html>